<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hakli Symbol Recognizer - OpenCV Enhanced</title>
    <script src="https://docs.opencv.org/4.8.0/opencv.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useCallback, useEffect } = React;

        const Eye = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
        );

        const Upload = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
        );

        const FileText = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
            </svg>
        );

        const Settings = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"/>
            </svg>
        );

        const Zap = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polygon points="13,2 3,14 12,14 11,22 21,10 12,10 13,2"/>
            </svg>
        );

        const Camera = () => (
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
                <circle cx="12" cy="13" r="4"/>
            </svg>
        );

        const CheckCircle = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                <polyline points="22,4 12,14.01 9,11.01"/>
            </svg>
        );

        const AlertCircle = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
        );

        const ImageIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21,15 16,10 5,21"/>
            </svg>
        );

        const HakliSymbolRecognizer = () => {
            const [equivalenceChart, setEquivalenceChart] = useState(null);
            const [uploadedImage, setUploadedImage] = useState(null);
            const [recognitionResults, setRecognitionResults] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [imageAnalysis, setImageAnalysis] = useState(null);
            const [chartLoadStatus, setChartLoadStatus] = useState('ready');
            const [jsonInput, setJsonInput] = useState('');
            const [showJsonInput, setShowJsonInput] = useState(false);
            const [loadedSymbolImages, setLoadedSymbolImages] = useState({});
            const [isOpenCVReady, setIsOpenCVReady] = useState(false);
            const [wordBoundaries, setWordBoundaries] = useState(new Set());
            const [isolatedSymbolsDebug, setIsolatedSymbolsDebug] = useState([]);
            const [processingSettings, setProcessingSettings] = useState({
                contrastThreshold: 127,
                minSymbolSize: 15,
                maxSymbolSize: 200,
                detectionSensitivity: 0.7,
                variantMatching: true
            });
            
            const canvasRef = useRef(null);
            const imageRef = useRef(null);
            const analysisCanvasRef = useRef(null);

            // Check if OpenCV is ready
            useEffect(() => {
                const checkOpenCV = () => {
                    if (typeof cv !== 'undefined' && cv.Mat) {
                        console.log('✅ OpenCV.js loaded successfully');
                        setIsOpenCVReady(true);
                    } else {
                        console.log('⏳ Waiting for OpenCV.js...');
                        setTimeout(checkOpenCV, 100);
                    }
                };
                checkOpenCV();
            }, []);

            // Convert relative paths to full GitHub URLs
            const convertToGitHubUrl = useCallback((relativePath) => {
                if (!relativePath) return null;
                if (relativePath.startsWith('http')) return relativePath;
                
                const baseUrl = 'https://raw.githubusercontent.com/hytra3/hakli-recognizer/main/';
                const fullUrl = baseUrl + relativePath;
                console.log(`Converting path: "${relativePath}" -> "${fullUrl}"`);
                return fullUrl;
            }, []);

            // Load symbol images from URLs
            const loadSymbolImages = useCallback(async (symbols) => {
                const imageCache = {};
                
                for (const symbol of symbols) {
                    try {
                        if (symbol.images) {
                            // Load primary image
                            if (symbol.images.primary) {
                                try {
                                    const fullUrl = convertToGitHubUrl(symbol.images.primary);
                                    if (fullUrl) {
                                        const img = new Image();
                                        img.crossOrigin = 'anonymous';
                                        await new Promise((resolve, reject) => {
                                            img.onload = () => {
                                                console.log(`✅ Successfully loaded: ${fullUrl}`);
                                                imageCache[`${symbol.id}_primary`] = img;
                                                resolve();
                                            };
                                            img.onerror = (error) => {
                                                console.error(`❌ Failed to load: ${fullUrl}`, error);
                                                reject(error);
                                            };
                                            img.src = fullUrl;
                                        });
                                    }
                                } catch (e) {
                                    console.warn(`Failed to load primary image for ${symbol.name}:`, e);
                                }
                            }

                            // Load variant images
                            if (symbol.images.variants && Array.isArray(symbol.images.variants)) {
                                for (let i = 0; i < symbol.images.variants.length; i++) {
                                    try {
                                        const fullUrl = convertToGitHubUrl(symbol.images.variants[i]);
                                        if (fullUrl) {
                                            const img = new Image();
                                            img.crossOrigin = 'anonymous';
                                            await new Promise((resolve, reject) => {
                                                img.onload = () => {
                                                    imageCache[`${symbol.id}_variant_${i}`] = img;
                                                    resolve();
                                                };
                                                img.onerror = reject;
                                                img.src = fullUrl;
                                            });
                                        }
                                    } catch (e) {
                                        console.warn(`Failed to load variant ${i} for ${symbol.name}:`, e);
                                    }
                                }
                            }

                            // Load example images
                            if (symbol.images.examples && Array.isArray(symbol.images.examples)) {
                                for (let i = 0; i < symbol.images.examples.length; i++) {
                                    try {
                                        const fullUrl = convertToGitHubUrl(symbol.images.examples[i]);
                                        if (fullUrl) {
                                            const img = new Image();
                                            img.crossOrigin = 'anonymous';
                                            await new Promise((resolve, reject) => {
                                                img.onload = () => {
                                                    imageCache[`${symbol.id}_example_${i}`] = img;
                                                    resolve();
                                                };
                                                img.onerror = reject;
                                                img.src = fullUrl;
                                            });
                                        }
                                    } catch (e) {
                                        console.warn(`Failed to load example ${i} for ${symbol.name}:`, e);
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.warn(`Error processing images for symbol ${symbol.name}:`, error);
                    }
                }
                
                return imageCache;
            }, [convertToGitHubUrl]);

            // Helper function to categorize symbols
            const determineSymbolCategory = useCallback((symbolName) => {
                if (symbolName.includes('-dot')) return "Dotted Letters";
                if (symbolName.includes('-bar')) return "Barred Letters";
                if (symbolName.includes('-breve')) return "Modified Letters";
                if (['(', ')'].includes(symbolName)) return "Punctuation";
                if (['h', 'l', 'm', 'q', 'w', 's-1', 's-2', 'r', 'b', 't', 'k', 'n', 'f', 'g', 'd', 'y', 'z'].includes(symbolName.replace('-dot', '').replace('-bar', '').replace('-breve', ''))) {
                    return "Basic Consonants";
                }
                return "Other Symbols";
            }, []);

            // Load chart from GitHub
            const loadChart = useCallback(() => {
                console.log('🔄 Manual reload triggered');
                
                const loadChartInternal = async () => {
                    console.log('🔄 loadChart function started');
                    setChartLoadStatus('loading');
                    
                    const githubJsonUrl = 'https://raw.githubusercontent.com/hytra3/hakli-recognizer/main/Hakli_symbols.JSON';
                    
                    try {
                        console.log('📡 Fetching JSON from:', githubJsonUrl);
                        const response = await fetch(githubJsonUrl);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const chartData = await response.json();
                        console.log('✅ JSON loaded successfully');
                        
                        const processedChart = {
                            chart_name: "Hakli Archaeological Script Symbols",
                            version: "1.0", 
                            source_image: chartData.source_image || "github_chart",
                            extraction_date: chartData.extraction_date || new Date().toISOString(),
                            symbols: chartData.symbols.map(symbol => ({
                                ...symbol,
                                english_equivalent: symbol.name,
                                category: determineSymbolCategory(symbol.name),
                                confidence_weights: {
                                    primary: 1.0,
                                    variants: 0.9,
                                    examples: 0.8
                                }
                            })),
                            categories: [...new Set(chartData.symbols.map(s => determineSymbolCategory(s.name)))],
                            metadata: {
                                created: chartData.extraction_date || new Date().toISOString(),
                                total_symbols: chartData.symbols.length,
                                total_images: chartData.symbols.reduce((sum, s) => {
                                    return sum + 1 + (s.images.variants?.length || 0) + (s.images.examples?.length || 0);
                                }, 0)
                            }
                        };
                        
                        setEquivalenceChart(processedChart);
                        setChartLoadStatus('loaded');
                        
                        console.log('🖼️ Starting to load symbol images...');
                        const imageCache = await loadSymbolImages(processedChart.symbols);
                        console.log('✅ Image loading complete. Loaded count:', Object.keys(imageCache).length);
                        setLoadedSymbolImages(imageCache);
                        
                    } catch (error) {
                        console.error('❌ Error loading chart from GitHub:', error);
                        setChartLoadStatus('error');
                    }
                };
                
                loadChartInternal();
            }, [loadSymbolImages, determineSymbolCategory]);

            // Auto-load chart on startup
            useEffect(() => {
                console.log('⚡ useEffect triggered - about to load chart from GitHub');
                loadChart();
            }, []);

            return (
                <div className="max-w-7xl mx-auto p-4 bg-gray-50 min-h-screen">
                    <div className="bg-white rounded-lg shadow-lg p-6">
                        <h1 className="text-3xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                            <Eye />
                            Hakli Symbol Recognizer
                            <span className="text-sm font-normal text-gray-500 ml-2">Debug Version - Basic Interface</span>
                        </h1>
                        
                        <div className="space-y-4">
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h3 className="font-semibold text-blue-800 mb-2">Chart Status</h3>
                                <button
                                    onClick={loadChart}
                                    className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                                    disabled={chartLoadStatus === 'loading'}
                                >
                                    {chartLoadStatus === 'loading' ? 'Loading...' : 'Load Chart'}
                                </button>
                                
                                {equivalenceChart && (
                                    <div className="mt-3 text-sm text-green-600">
                                        ✅ Loaded {equivalenceChart.symbols?.length || 0} symbols, {Object.keys(loadedSymbolImages).length} images
                                    </div>
                                )}
                                
                                {chartLoadStatus === 'error' && (
                                    <div className="mt-3 text-sm text-red-600">
                                        ❌ Failed to load chart
                                    </div>
                                )}
                            </div>

                            <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h3 className="font-semibold text-green-800 mb-2">Debug Status</h3>
                                <div className="text-sm">
                                    <p>OpenCV Ready: {isOpenCVReady ? '✅' : '❌'}</p>
                                    <p>Chart Loaded: {equivalenceChart ? '✅' : '❌'}</p>
                                    <p>Images Loaded: {Object.keys(loadedSymbolImages).length}</p>
                                    <p>React Rendering: ✅</p>
                                </div>
                            </div>

                            <div className="bg-gray-100 border border-gray-200 rounded-lg p-4">
                                <p className="text-center text-gray-600">
                                    This is a simplified debug version to test basic functionality.
                                    <br />
                                    Check the browser console for detailed logs.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<HakliSymbolRecognizer />);
    </script>
</body>
</html>